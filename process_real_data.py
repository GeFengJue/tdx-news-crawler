import json
import sqlite3
import pandas as pd
from datetime import datetime

# 您提供的真实API响应数据
real_response = {
    "HitCache": "L1:B1FB6080A43E",
    "ErrorCode": 0,
    "ResultSets": [
        {
            "ColName": [
                "pos",
                "rec_id",
                "title",
                "issue_date",
                "summary",
                "src_info",
                "relate_id",
                "Proc_Id",
                "Mark_Id"
            ],
            "Content": [
                [1,5549513,"*ST金比(002762):关于变更参股公司董事、监事委派人员的自愿性信息披露公告","2025-09-24 17:57:00","*ST金比(002762):关于变更参股公司董事、监事委派人员的自愿性信息披露公告","深交所",20009684,0,1],
                [2,5549507,"蓝特光学(688127):2025年第二次临时股东大会决议公告","2025-09-24 17:57:00","蓝特光学(688127):2025年第二次临时股东大会决议公告","上交所",20009678,0,1],
                [3,5549506,"蓝特光学(688127):2025年第二次临时股东大会的法律意见书","2025-09-24 17:57:00","蓝特光学(688127):2025年第二次临时股东大会的法律意见书","上交所",20009677,0,1],
                [4,5549505,"蓝特光学(688127):关于选举职工代表董事、增选非独立董事、聘任副总经理的公告","2025-09-24 17:57:00","蓝特光学(688127):关于选举职工代表董事、增选非独立董事、聘任副总经理的公告","上交所",20009676,0,1],
                [5,5549504,"中惠旅(834260):提供担保的公告","2025-09-24 17:56:54","中惠旅(834260):提供担保的公告","股份转让系统",20009673,1,1],
                [6,5549503,"新农人(872242):关于全资子公司为母公司提供担保的公告","2025-09-24 17:56:54","新农人(872242):关于全资子公司为母公司提供担保的公告","股份转让系统",20009672,1,1],
                [7,5549502,"大亚股份(832532):预计担保的公告","2025-09-24 17:56:54","大亚股份(832532):预计担保的公告","股份转让系统",20009671,1,1],
                [8,5549501,"海控能源(833042):出售资产暨关联交易的公告","2025-09-24 17:56:50","海控能源(833042):出售资产暨关联交易的公告","股份转让系统",20009670,1,1],
                [9,5549499,"ST太和华(837694):对外投资的公告","2025-09-24 17:56:47","ST太和华(837694):对外投资的公告","股份转让系统",20009667,1,1],
                [10,5549498,"声蓝医疗(874309):对外设立孙公司的公告","2025-09-24 17:56:47","声蓝医疗(874309):对外设立孙公司的公告","股份转让系统",20009666,1,1],
                [11,5549497,"味巴哥(871988):关联交易公告","2025-09-24 17:56:29","味巴哥(871988):关联交易公告","股份转让系统",20009665,1,4],
                [12,5549512,"富国银行:AI牛市非泡沫 仍处早期阶段","2025-09-24 17:56:08","富国银行首席股票策略师Ohsung Kwon看好AI相关股票,认为AI驱动的牛市将持续。他指出,当前涨势非泡沫,而是由优于标普500的基本面支撑,纳斯达克指数的超额收益长期由科技成长驱动。目前仍处AI投资周期早期,只要股市对资本支出和增长前景持续给予积极反馈,本轮行情有望延续。","格隆汇",20009683,0,1],
                [13,5549495,"九喜股份(872784):拟变更经营范围并修订《公司章程》公告","2025-09-24 17:56:05","九喜股份(872784):拟变更经营范围并修订《公司章程》公告","股份转让系统",20009663,0,1],
                [14,5549494,"亮威科技(839472):拟修订公司章程公告","2025-09-24 17:56:05","亮威科技(839472):拟修订公司章程公告","股份转让系统",20009661,0,1],
                [15,5549493,"ST太和华(837694):拟修订《公司章程》公告","2025-09-24 17:56:05","ST太和华(837694):拟修订《公司章程》公告","股份转让系统",20009659,0,1],
                [16,5549514,"康泰生物(300601):关于三价流感病毒裂解疫苗上市许可申请获得受理的公告","2025-09-24 17:56:00","康泰生物(300601):关于三价流感病毒裂解疫苗上市许可申请获得受理的公告","深交所",20009685,0,1],
                [17,5549496,"康强电子(002119):关于持股5%以上股东权益变动触及1%整数倍的公告","2025-09-24 17:56:00","康强电子(002119):关于持股5%以上股东权益变动触及1%整数倍的公告","深交所",20009664,1,1],
                [18,5549489,"五轮科技(833767):信息披露事务管理制度","2025-09-24 17:55:37","五轮科技(833767):信息披露事务管理制度","股份转让系统",20009657,0,1],
                [19,5549488,"五轮科技(833767):投资者关系管理制度","2025-09-24 17:55:37","五轮科技(833767):投资者关系管理制度","股份转让系统",20009656,0,1],
                [20,5549487,"五轮科技(833767):募集资金管理制度","2025-09-24 17:55:37","五轮科技(833767):募集资金管理制度","股份转让系统",20009655,0,1],
                [21,5549486,"亮威科技(839472):股东会议事规则","2025-09-24 17:55:37","亮威科技(839472):股东会议事规则","股份转让系统",20009654,0,1],
                [22,5549485,"天健新材(874508):股东会议事规则(草案)(北交所上市后适用)","2025-09-24 17:55:37","天健新材(874508):股东会议事规则(草案)(北交所上市后适用)","股份转让系统",20009651,0,1],
                [23,5549484,"ST太和华(837694):募集资金管理制度","2025-09-24 17:55:37","ST太和华(837694):募集资金管理制度","股份转让系统",20009650,0,1],
                [24,5549483,"亮威科技(839472):防止控股股东或实际控制人及其关联方占用公司资金管理制度","2025-09-24 17:55:37","亮威科技(839472):防止控股股东或实际控制人及其关联方占用公司资金管理制度","股份转让系统",20009649,0,1],
                [25,5549482,"亮威科技(839472):投资者关系管理制度","2025-09-24 17:55:37","亮威科技(839472):投资者关系管理制度","股份转让系统",20009648,0,1],
                [26,5549481,"味巴哥(871988):股东会议事规则","2025-09-24 17:55:37","味巴哥(871988):股东会议事规则","股份转让系统",20009646,0,1],
                [27,5549480,"亮威科技(839472):对外担保管理制度","2025-09-24 17:55:37","亮威科技(839472):对外担保管理制度","股份转让系统",20009645,0,1],
                [28,5549479,"亮威科技(839472):关联交易管理制度","2025-09-24 17:55:37","亮威科技(839472):关联交易管理制度","股份转让系统",20009644,0,1],
                [29,5549478,"亮威光学(839472):利润分配管理制度","2025-09-24 17:55:37","亮威光学(839472):利润分配管理制度","股份转让系统",20009643,0,1],
                [30,5549477,"亮威光学(839472):对外投资管理制度","2025-09-24 17:55:37","亮威光学(839472):对外投资管理制度","股份转让系统",20009642,0,1],
                [31,5549476,"味巴哥(871988):董事会议事规则","2025-09-24 17:55:37","味巴哥(871988):董事会议事规则","股份转让系统",20009641,0,1],
                [32,5549475,"天健新材(874508):关联交易管理办法(草案)(北交所上市后适用)","2025-09-24 17:55:33","天健新材(874508):关联交易管理办法(草案)(北交所上市后适用)","股份转让系统",20009640,0,1],
                [33,5549474,"天健新材(874508):募集资金管理制度(草案)(北交所上市后适用)","2025-09-24 17:55:33","天健新材(874508):募集资金管理制度(草案)(北交所上市后适用)","股份转让系统",20009639,0,1],
                [34,5549473,"天健新材(874508):投资者关系管理制度(草案)(北交所上市后适用)","2025-09-24 17:55:33","天健新材(874508):投资者关系管理制度(草案)(北交所上市后适用)","股份转让系统",20009638,0,1],
                [35,5549472,"天健新材(874508):对外担保管理办法(草案)(北交所上市后适用)","2025-09-24 17:55:33","天健新材(874508):对外担保管理办法(草案)(北交所上市后适用)","股份转让系统",20009637,0,1],
                [36,5549471,"天健新材(874508):利润分配管理制度(草案)(北交所上市后适用)","2025-09-24 17:55:33","天健新材(874508):利润分配管理制度(草案)(北交所上市后适用)","股份转让系统",20009636,0,1],
                [37,5549470,"天健新材(874508):独立董事工作制度(草案)(北交所上市后适用)","2025-09-24 17:55:33","天健新材(874508):独立董事工作制度(草案)(北交所上市后适用)","股份转让系统",20009635,0,1],
                [38,5549469,"天健新材(874508):防范控股股东、实际控制人及其他关联方占用公司资金管理制度(草案)(北交所上市后适用)","2025-09-24 17:55:33","天健新材(874508):防范控股股东、实际控制人及其他关联方占用公司资金管理制度(草案)(北交所上市后适用)","股份转让系统",20009634,0,1],
                [39,5549468,"天健新材(874508):对外投资管理办法(草案)(北交所上市后适用)","2025-09-24 17:55:33","天健新材(874508):对外投资管理办法(草案)(北交所上市后适用)","股份转让系统",20009633,0,1],
                [40,5549467,"天健新材(874508):董事会秘书工作细则(草案)(北交所上市后适用)","2025-09-24 17:55:33","天健新材(874508):董事会秘书工作细则(草案)(北交所上市后适用)","股份转让系统",20009632,0,1],
                [41,5549466,"天健新材(874508):累积投票制实施细则(草案)(北交所上市后适用)","2025-09-24 17:55:33","天健新材(874508):累积投票制实施细则(草案)(北交所上市后适用)","股份转让系统",20009631,0,1],
                [42,5549465,"天健新材(874508):信息披露管理制度(草案)(北交所上市后适用)","2025-09-24 17:55:33","天健新材(874508):信息披露管理制度(草案)(北交所上市后适用)","股份转让系统",20009630,0,1],
                [43,5549464,"天健新材(874508):董事和高级管理人员所持本公司股份及其变动管理制度(草案)(北交所上市后适用)","2025-09-24 17:55:33","天健新材(874508):董事和高级管理人员所持本公司股份及其变动管理制度(草案)(北交所上市后适用)","股份转让系统",20009629,0,1],
                [44,5549463,"味巴哥(871988):对外担保管理制度","2025-09-24 17:55:33","味巴哥(871988):对外担保管理制度","股份转让系统",20009627,0,1],
                [45,5549462,"味巴哥(871988):对外投资管理制度","2025-09-24 17:55:33","味巴哥(871988):对外投资管理制度","股份转让系统",20009626,0,1],
                [46,5549461,"天健新材(874508):董事及高级管理人员薪酬管理制度(草案)(北交所上市后适用)","2025-09-24 17:55:33","天健新材(874508):董事及高级管理人员薪酬管理制度(草案)(北交所上市后适用)","股份转让系统",20009625,0,1],
                [47,5549460,"天健新材(874508):总经理工作细则(草案)(北交所上市后适用)","2025-09-24 17:55:33","天健新材(874508):总经理工作细则(草案)(北交所上市后适用)","股份转让系统",20009624,0,1],
                [48,5549459,"天健新材(874508):子公司管理制度(草案)(北交所上市后适用)","2025-09-24 17:55:33","天健新材(874508):子公司管理制度(草案)(北交所上市后适用)","股份转让系统",20009623,0,1],
                [49,5549458,"亮威科技(839472):监事会议事规则","2025-09-24 17:55:33","亮威科技(839472):监事会议事规则","股份转让系统",20009622,0,1],
                [50,5549457,"天健新材(874508):内部审计制度(草案)(北交所上市后适用)","2025-09-24 17:55:33","天健新材(874508):内部审计制度(草案)(北交所上市后适用)","股份转让系统",20009621,0,1]
            ]
        }
    ]
}

def create_database():
    """创建SQLite数据库"""
    conn = sqlite3.connect('real_news_data.db')
    cursor = conn.cursor()
    
    # 创建新闻数据表
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS stock_news (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        position INTEGER,
        record_id INTEGER UNIQUE,
        title TEXT,
        issue_date TEXT,
        summary TEXT,
        source TEXT,
        relate_id INTEGER,
        proc_id INTEGER,
        mark_id INTEGER,
        stock_code TEXT,
        stock_name TEXT,
        created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
    ''')
    
    # 创建索引
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_record_id ON stock_news(record_id)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_stock_code ON stock_news(stock_code)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_issue_date ON stock_news(issue_date)')
    
    conn.commit()
    return conn

def extract_stock_info(title):
    """从标题中提取股票代码和名称"""
    import re
    # 匹配模式：股票名称(股票代码)
    pattern = r'([^\(]+)\((\d{6})\)'
    match = re.search(pattern, title)
    if match:
        stock_name = match.group(1).strip()
        stock_code = match.group(2)
        return stock_code, stock_name
    return None, None

def process_and_save_data(conn):
    """处理数据并保存到数据库"""
    cursor = conn.cursor()
    
    # 获取数据
    col_names = real_response['ResultSets'][0]['ColName']
    content_data = real_response['ResultSets'][0]['Content']
    
    print(f"📊 开始处理 {len(content_data)} 条新闻数据...")
    
    inserted_count = 0
    for row in content_data:
        # 创建数据字典
        data_dict = dict(zip(col_names, row))
        
        # 提取股票信息
        stock_code, stock_name = extract_stock_info(data_dict['title'])
        
        try:
            # 插入数据
            cursor.execute('''
            INSERT OR IGNORE INTO stock_news 
            (position, record_id, title, issue_date, summary, source, relate_id, proc_id, mark_id, stock_code, stock_name)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                data_dict['pos'],
                data_dict['rec_id'],
                data_dict['title'],
                data_dict['issue_date'],
                data_dict['summary'],
                data_dict['src_info'],
                data_dict['relate_id'],
                data_dict['Proc_Id'],
                data_dict['Mark_Id'],
                stock_code,
                stock_name
            ))
            
            inserted_count += 1
            
        except Exception as e:
            print(f"❌ 插入数据失败: {e}")
    
    conn.commit()
    print(f"✅ 成功插入 {inserted_count} 条数据到数据库")
    
    # 显示数据统计
    cursor.execute("SELECT COUNT(*) FROM stock_news")
    total_count = cursor.fetchone()[0]
    
    cursor.execute("SELECT COUNT(DISTINCT stock_code) FROM stock_news WHERE stock_code IS NOT NULL")
    stock_count = cursor.fetchone()[0]
    
    cursor.execute("SELECT COUNT(DISTINCT source) FROM stock_news")
    source_count = cursor.fetchone()[0]
    
    print(f"\n📈 数据统计:")
    print(f"   总记录数: {total_count}")
    print(f"   股票数量: {stock_count}")
    print(f"   来源数量: {source_count}")

def export_to_csv(conn):
    """导出数据到CSV文件"""
    df = pd.read_sql_query("SELECT * FROM stock_news", conn)
    df.to_csv('real_news_export.csv', index=False, encoding='utf-8-sig')
    print("✅ 数据已导出到: real_news_export.csv")

def main():
    print("🚀 开始处理真实API数据...")
    
    # 创建数据库
    conn = create_database()
    print("✅ 数据库创建成功")
    
    # 处理并保存数据
    process_and_save_data(conn)
    
    # 导出到CSV
    export_to_csv(conn)
    
    # 关闭连接
    conn.close()
    print("🎉 数据处理完成!")

if __name__ == "__main__":
    main()